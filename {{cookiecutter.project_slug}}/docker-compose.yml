# Docker Compose for {{ cookiecutter.project_name }}
#
# Usage:
#   docker compose up                    # Run production server
#   docker compose --profile dev up      # Run development server with hot reload
#   docker compose build                 # Build all images
#
# Environment variables (optional):
#   PYTHON_VERSION: Python version for images (default: 3.12)
#   LANGFUSE_PUBLIC_KEY, LANGFUSE_SECRET_KEY, LANGFUSE_HOST

services:
  # Production server
  {{cookiecutter.project_slug}}:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: production
      args:
        - PYTHON_VERSION=${PYTHON_VERSION:-3.12}
    image: ghcr.io/{{ cookiecutter.github_username }}/{{ cookiecutter.project_slug }}:latest
    ports:
      - "8000:8000"
    environment:
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-https://cloud.langfuse.com}
    restart: unless-stopped

  # Development server with hot reload
  dev:
    build:
      context: .
      dockerfile: docker/Dockerfile.dev
      args:
        - PYTHON_VERSION=${PYTHON_VERSION:-3.12}
    ports:
      - "8000:8000"
    volumes:
      - ./app:/app/app:ro
    environment:
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-https://cloud.langfuse.com}
    profiles:
      - dev

  # Build the base image (for publishing)
  base:
    build:
      context: .
      dockerfile: docker/Dockerfile.base
      args:
        - PYTHON_VERSION=${PYTHON_VERSION:-3.12}
    image: ghcr.io/{{ cookiecutter.github_username }}/{{ cookiecutter.project_slug }}-base:latest
    profiles:
      - build
