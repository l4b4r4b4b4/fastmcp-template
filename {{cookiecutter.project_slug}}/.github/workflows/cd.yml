# CD Pipeline for FastMCP Template
#
# Deployment workflow placeholder - customize for your infrastructure.
#
# This workflow:
# - Triggers after Release workflow completes (images are built)
# - Supports manual deployments to different environments
# - Is designed to work with self-hosted runners
#
# Runner Configuration:
# =====================
# This workflow supports both GitHub-hosted and self-hosted runners.
#
# To use self-hosted runners:
# 1. Set repository variable RUNNER_LABEL to match your runner labels
#    Example: "self-hosted" or "threadripper" or "nixos"
#
# 2. Register a runner for this repo/org. Example NixOS config:
#    ```nix
#    services.github-runners."my-runner" = {
#      enable = true;
#      url = "https://github.com/OWNER/REPO";  # or org URL
#      tokenFile = "/run/secrets/github_token";
#      extraLabels = ["self-hosted" "nixos" "your-label"];
#      extraPackages = with pkgs; [docker kubectl helm];
#    };
#    ```
#
# 3. Ensure runner has access to your deployment target (k8s, docker host, etc.)
#
# Deployment Targets:
# ==================
# Uncomment and customize the deployment job for your infrastructure:
# - Kubernetes (kubectl/helm)
# - Docker Compose on remote host
# - Cloud Run / ECS / App Runner
# - Fly.io / Railway / Render

name: CD - Deploy

on:
  # Auto-deploy to staging after successful release
  workflow_run:
    workflows: ["Release"]
    types: [completed]
    branches: [main]

  # Manual deployment trigger
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: "Image tag to deploy (default: latest)"
        required: false
        default: "latest"

# Only one deployment at a time per environment
concurrency:
  group: deploy-{%  raw %}${{ github.event.inputs.environment || 'staging' }}{% endraw %}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: {%  raw %}${{ github.repository_owner }}{% endraw %}/fastmcp-template

jobs:
  # Gate: Only proceed if Release workflow passed
  check-release:
    name: Verify Release
    runs-on: {%  raw %}${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}{% endraw %}
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    outputs:
      should_deploy: {%  raw %}${{ steps.check.outputs.should_deploy }}{% endraw %}
      image_tag: {%  raw %}${{ steps.check.outputs.image_tag }}{% endraw %}

    steps:
      - name: Check release status
        id: check
        run: |
          if [[ "{%  raw %}${{ github.event_name }}{% endraw %}" == "workflow_dispatch" ]]; then
            echo "Manual trigger - using tag: {%  raw %}${{ github.event.inputs.image_tag }}{% endraw %}"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "image_tag={%  raw %}${{ github.event.inputs.image_tag }}{% endraw %}" >> $GITHUB_OUTPUT
          elif [[ "{%  raw %}${{ github.event.workflow_run.conclusion }}{% endraw %}" == "success" ]]; then
            echo "Release passed - deploying latest"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "image_tag=latest" >> $GITHUB_OUTPUT
          else
            echo "Release did not pass - skipping deployment"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # ==========================================================================
  # DEPLOYMENT JOB - Customize for your infrastructure
  # ==========================================================================
  #
  # Option 1: Docker Compose on remote host
  # ---------------------------------------
  # deploy:
  #   name: Deploy via Docker Compose
  #   runs-on: {%  raw %}${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}{% endraw %}
  #   needs: check-release
  #   if: needs.check-release.outputs.should_deploy == 'true'
  #   environment:
  #     name: {%  raw %}${{ github.event.inputs.environment || 'staging' }}{% endraw %}
  #
  #   steps:
  #     - name: Deploy to remote host
  #       uses: appleboy/ssh-action@v1.0.0
  #       with:
  #         host: {%  raw %}${{ secrets.DEPLOY_HOST }}{% endraw %}
  #         username: {%  raw %}${{ secrets.DEPLOY_USER }}{% endraw %}
  #         key: {%  raw %}${{ secrets.DEPLOY_SSH_KEY }}{% endraw %}
  #         script: |
  #           cd /opt/fastmcp-template
  #           docker compose pull
  #           docker compose up -d
  #
  # Option 2: Kubernetes with kubectl
  # ---------------------------------
  # deploy:
  #   name: Deploy to Kubernetes
  #   runs-on: {%  raw %}${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}{% endraw %}
  #   needs: check-release
  #   if: needs.check-release.outputs.should_deploy == 'true'
  #
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Set up kubectl
  #       run: |
  #         mkdir -p ~/.kube
  #         echo "{%  raw %}${{ secrets.KUBECONFIG }}{% endraw %}" | base64 -d > ~/.kube/config
  #     - name: Deploy
  #       run: |
  #         kubectl set image deployment/fastmcp-template \
  #           fastmcp-template={%  raw %}${{ env.REGISTRY }}{% endraw %}/{%  raw %}${{ env.IMAGE_NAME }}{% endraw %}:{%  raw %}${{ needs.check-release.outputs.image_tag }}{% endraw %} \
  #           -n fastmcp
  #         kubectl rollout status deployment/fastmcp-template -n fastmcp
  #
  # Option 3: Fly.io
  # ----------------
  # deploy:
  #   name: Deploy to Fly.io
  #   runs-on: {%  raw %}${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}{% endraw %}
  #   needs: check-release
  #   if: needs.check-release.outputs.should_deploy == 'true'
  #
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: superfly/flyctl-actions/setup-flyctl@master
  #     - run: flyctl deploy --image {%  raw %}${{ env.REGISTRY }}{% endraw %}/{%  raw %}${{ env.IMAGE_NAME }}{% endraw %}:{%  raw %}${{ needs.check-release.outputs.image_tag }}{% endraw %}
  #       env:
  #         FLY_API_TOKEN: {%  raw %}${{ secrets.FLY_API_TOKEN }}{% endraw %}

  # Placeholder - remove when you add a real deployment
  deploy-placeholder:
    name: Deployment Placeholder
    runs-on: {%  raw %}${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}{% endraw %}
    needs: check-release
    if: needs.check-release.outputs.should_deploy == 'true'
    environment:
      name: {%  raw %}${{ github.event.inputs.environment || 'staging' }}{% endraw %}

    steps:
      - name: Deployment info
        run: |
          echo "## Deployment Ready :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | {%  raw %}${{ github.event.inputs.environment || 'staging' }}{% endraw %} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`{%  raw %}${{ env.REGISTRY }}{% endraw %}/{%  raw %}${{ env.IMAGE_NAME }}{% endraw %}:{%  raw %}${{ needs.check-release.outputs.image_tag }}{% endraw %}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Runner | \`{%  raw %}${{ runner.name }}{% endraw %}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** This is a placeholder. Edit \`.github/workflows/cd.yml\` to add your deployment logic." >> $GITHUB_STEP_SUMMARY
