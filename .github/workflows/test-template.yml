name: Test Template

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-template-generation:
    name: Test ${{ matrix.config.name }} configuration
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: minimal
            demo_tools: "no"
            secret_tools: "no"
            expected_tests: 75
          - name: full
            demo_tools: "yes"
            secret_tools: "yes"
            expected_tests: 101
          - name: demos-only
            demo_tools: "yes"
            secret_tools: "no"
            expected_tests: 86
          - name: secrets-only
            demo_tools: "no"
            secret_tools: "yes"
            expected_tests: 85

    steps:
      - name: Checkout template repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install cookiecutter
        run: uv tool install cookiecutter

      - name: Generate project from template
        run: |
          uv tool run cookiecutter . --output-dir /tmp/test-output --no-input \
            project_name="Test ${{ matrix.config.name }}" \
            project_slug="test-${{ matrix.config.name }}" \
            include_demo_tools="${{ matrix.config.demo_tools }}" \
            include_secret_tools="${{ matrix.config.secret_tools }}"

      - name: List generated files
        run: |
          echo "Generated project structure:"
          ls -la /tmp/test-output/test-${{ matrix.config.name }}/

      - name: Run tests in generated project
        working-directory: /tmp/test-output/test-${{ matrix.config.name }}
        run: |
          uv run pytest -v --tb=short

      - name: Verify test count
        working-directory: /tmp/test-output/test-${{ matrix.config.name }}
        run: |
          TEST_COUNT=$(uv run pytest --collect-only -q 2>/dev/null | grep -c "test_" || echo "0")
          echo "Expected: ${{ matrix.config.expected_tests }} tests"
          echo "Found: $TEST_COUNT tests"
          if [ "$TEST_COUNT" -ne "${{ matrix.config.expected_tests }}" ]; then
            echo "❌ Test count mismatch!"
            exit 1
          fi
          echo "✅ Test count matches expected"

      - name: Run linting checks
        working-directory: /tmp/test-output/test-${{ matrix.config.name }}
        run: |
          uv run ruff check . --fix || true
          uv run ruff check .

      - name: Check for hardcoded template values
        working-directory: /tmp/test-output/test-${{ matrix.config.name }}
        run: |
          echo "Checking for hardcoded 'fastmcp-template' references..."
          if grep -r "fastmcp-template" --exclude-dir=.git --exclude-dir=.venv --exclude-dir=.ruff_cache --exclude="*.pyc" .; then
            echo "❌ Found hardcoded 'fastmcp-template' references!"
            exit 1
          fi
          echo "✅ No hardcoded template values found"

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test-template-generation
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.test-template-generation.result }}" != "success" ]; then
            echo "❌ Template testing failed"
            exit 1
          fi
          echo "✅ All template configurations tested successfully!"
